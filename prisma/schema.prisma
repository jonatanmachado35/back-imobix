generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum Role {
  ADMIN
  USER
}

enum StatusFuncionario {
  ATIVO
  INATIVO
}

enum LeadStatus {
  NOVO
  CONTATADO
  QUALIFICADO
  CONVERTIDO
  PERDIDO
}

enum TipoPropriedade {
  CASA_PRAIA
  APARTAMENTO_PRAIA
  SITIO
  CHACARA
  CASA_CAMPO
  COBERTURA
  OUTRO
}

enum StatusPropriedade {
  AGUARDANDO_APROVACAO
  ATIVO
  INATIVO
  REJEITADO
}

enum CategoriaTransacao {
  RESERVA
  COMISSAO_CORRETOR
  PAGAMENTO_PROPRIETARIO
  TAXA_PLATAFORMA
  CANCELAMENTO
  TAXA_LIMPEZA
  TAXA_SERVICO
  OUTRO
}

enum TipoTransacao {
  ENTRADA
  SAIDA
}

enum StatusTransacao {
  PAGO
  PENDENTE
  CANCELADO
  PROCESSANDO
}

enum StatusReserva {
  CONFIRMADA
  PENDENTE
  CANCELADA
}

enum StatusVisita {
  AGENDADA
  REALIZADA
  CANCELADA
}

enum Sexo {
  MASCULINO
  FEMININO
  OUTRO
  PREFIRO_NAO_INFORMAR
}

model User {
  id           String   @id @default(cuid())
  nome         String
  email        String   @unique
  passwordHash String
  role         Role     @default(USER)
  avatar       String?
  phone        String?
  userRole     String?  @default("cliente") // 'cliente' | 'proprietario'
  refreshToken String?
  
  // Password Reset
  resetPasswordToken  String?   @unique
  resetPasswordExpiry DateTime?
  
  // Relations
  funcionario       Funcionario?
  corretor          Corretor?
  anuncios          Anuncio[]    @relation("AnunciosCriados")
  ownedProperties   Property[]   @relation("OwnerProperties")
  bookingsAsGuest   Booking[]    @relation("GuestBookings")
  favorites         Favorite[]
  activities        Activity[]
  clientConversations    ChatConversation[] @relation("ClientConversations")
  ownerConversations     ChatConversation[] @relation("OwnerConversations")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Funcionario {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  
  cpf          String?
  telefone     String?
  status       StatusFuncionario @default(ATIVO)
  dataCadastro DateTime @default(now())
}

model Corretor {
  id            String   @id @default(cuid())
  userId        String?  @unique // Optional link to a User login
  user          User?    @relation(fields: [userId], references: [id])
  
  nome          String
  creci         String?
  cpf           String?
  rg            String?
  telefone      String?
  sexo          Sexo?
  endereco      String?
  cidade        String?
  estado        String?
  cep           String?
  totalVendas   Int?     @default(0)
  especialidade String?
  comissaoTotal Decimal? @default(0.0) @db.Decimal(10, 2)
  
  // Relations
  transacoes    Transacao[]
  visitas       Visita[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Lead {
  id          String     @id @default(cuid())
  nome        String
  email       String
  telefone    String?
  origem      String?
  interesse   String?
  status      LeadStatus @default(NOVO)
  dataContato DateTime   @default(now())
  anotacoes   String?    @db.Text

  updatedAt   DateTime   @updatedAt
}

model PropriedadeTemporada {
  id                 String            @id @default(cuid())
  titulo             String
  tipo               TipoPropriedade
  endereco           String
  cidade             String
  estado             String
  valorDiaria        Decimal           @db.Decimal(10, 2)
  valorDiariaFimSemana Decimal         @db.Decimal(10, 2)
  status             StatusPropriedade @default(AGUARDANDO_APROVACAO)
  proprietario       String?           // Nome ou ID externo
  capacidadeHospedes Int
  quartos            Int
  camas              Int
  banheiros          Int
  areaTotal          Float?
  minimoNoites       Int               @default(1)
  dataEnvio          DateTime          @default(now())
  imagens            String[]
  
  // Relations
  transacoes         Transacao[]
  reservas           Reserva[]
  visitas            Visita[]

  updatedAt          DateTime          @updatedAt
}

model Transacao {
  id               String             @id @default(cuid())
  descricao        String
  categoria        CategoriaTransacao
  tipo             TipoTransacao
  valor            Decimal            @db.Decimal(10, 2)
  status           StatusTransacao    @default(PENDENTE)
  data             DateTime           @default(now())
  dataVencimento   DateTime?
  metodoPagamento  String?
  
  propriedadeId    String?
  propriedade      PropriedadeTemporada? @relation(fields: [propriedadeId], references: [id])
  
  corretorId       String?
  corretor         Corretor?           @relation(fields: [corretorId], references: [id])
  
  hospedeId        String?             // Can be a link to User or just a string ID for now
}

model Reserva {
  id            String        @id @default(cuid())
  propriedadeId String
  propriedade   PropriedadeTemporada @relation(fields: [propriedadeId], references: [id])
  
  hospede       String        // Nome do hospede
  checkIn       DateTime
  checkOut      DateTime
  valorTotal    Decimal       @db.Decimal(10, 2)
  status        StatusReserva @default(PENDENTE)
}

model Visita {
  id            String        @id @default(cuid())
  propriedadeId String
  propriedade   PropriedadeTemporada @relation(fields: [propriedadeId], references: [id])
  
  corretorId    String
  corretor      Corretor      @relation(fields: [corretorId], references: [id])
  
  cliente       String
  data          DateTime
  status        StatusVisita  @default(AGENDADA)
}

// Modelo para Anúncios (imobiliário geral)
model Anuncio {
  id              String           @id @default(cuid())
  titulo          String
  descricao       String?          @db.Text
  tipo            String
  endereco        String
  cidade          String
  estado          String
  valor           Decimal          @db.Decimal(10, 2)
  status          String           @default("ATIVO")
  
  // Propriedade do anúncio
  criadoPorId     String?          // ID do usuário que criou
  criadoPor       User?            @relation("AnunciosCriados", fields: [criadoPorId], references: [id], onDelete: SetNull)
  
  // Relations
  images          AnuncioImage[]
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@index([status])
  @@index([cidade])
  @@index([criadoPorId])
}

model AnuncioImage {
  id            String   @id @default(cuid())
  anuncioId     String
  anuncio       Anuncio  @relation(fields: [anuncioId], references: [id], onDelete: Cascade)
  
  publicId      String   @unique  // Cloudinary public_id
  url           String              // URL da imagem
  secureUrl     String              // HTTPS URL
  format        String              // jpg, png, etc
  width         Int?
  height        Int?
  bytes         Int?
  
  displayOrder  Int      @default(0)  // Ordem de exibição
  isPrimary     Boolean  @default(false)  // Imagem principal
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([anuncioId])
  @@index([isPrimary])
}

// ========================================
// NOVOS MODELOS - SPRINT 1-4
// ========================================

enum PropertyType {
  VENDA
  ALUGUEL
  TEMPORADA
}

enum PropertyStatus {
  ATIVO
  PAUSADO
  REMOVIDO
}

enum PropertyCategory {
  CHALE
  PRAIA
  FAZENDA
  SITIO
  LUXO
  CASA
  APARTAMENTO
}

enum DocumentationStatus {
  OK
  PENDING
  UNKNOWN
}

enum BookingStatus {
  PENDENTE
  CONFIRMADA
  CANCELADA
  CONCLUIDA
}

enum ActivityType {
  RESERVA_CRIADA
  RESERVA_CONFIRMADA
  RESERVA_CONCLUIDA
  RESERVA_CANCELADA
  FAVORITO_ADICIONADO
  MENSAGEM_ENVIADA
}

enum SenderRole {
  CLIENTE
  PROPRIETARIO
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

model Property {
  id                  String              @id @default(cuid())
  ownerId             String
  owner               User                @relation("OwnerProperties", fields: [ownerId], references: [id])
  
  type                PropertyType
  status              PropertyStatus      @default(ATIVO)
  title               String
  description         String?             @db.Text
  
  // Preços
  price               Decimal?            @db.Decimal(12, 2)
  currency            String              @default("BRL")
  pricePerNight       Decimal?            @db.Decimal(10, 2)
  holidayPrice        Decimal?            @db.Decimal(10, 2)
  
  // Localização
  address             String?
  city                String?
  neighborhood        String?
  
  // Características
  bedrooms            Int                 @default(0)
  bathrooms           Int                 @default(0)
  parkingSpaces       Int                 @default(0)
  area                Float?
  
  // Avaliações
  rating              Float?
  reviewCount         Int                 @default(0)
  
  // Amenidades
  amenities           String[]
  petFriendly         Boolean             @default(false)
  furnished           Boolean             @default(false)
  documentationStatus DocumentationStatus @default(UNKNOWN)
  
  // Temporada específico
  minNights           Int?
  maxGuests           Int?
  checkInTime         String?
  checkOutTime        String?
  houseRules          String[]
  category            PropertyCategory?
  blockedDates        String[]
  
  // Imagens
  images              PropertyImage[]
  
  // Relações
  bookings            Booking[]
  favorites           Favorite[]
  conversations       ChatConversation[]
  activities          Activity[]
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  @@index([status])
  @@index([type])
  @@index([city])
  @@index([ownerId])
}

model PropertyImage {
  id            String    @id @default(cuid())
  propertyId    String
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  publicId      String    @unique
  url           String
  secureUrl     String
  format        String
  width         Int?
  height        Int?
  bytes         Int?
  
  displayOrder  Int       @default(0)
  isPrimary     Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([propertyId])
}

model Booking {
  id              String        @id @default(cuid())
  propertyId      String
  property        Property      @relation(fields: [propertyId], references: [id])
  
  guestId         String
  guest           User          @relation("GuestBookings", fields: [guestId], references: [id])
  
  ownerId         String
  
  checkIn         DateTime
  checkOut        DateTime
  guests          Int
  adults          Int
  children        Int
  totalNights     Int
  
  pricePerNight   Decimal       @db.Decimal(10, 2)
  cleaningFee     Decimal       @db.Decimal(10, 2)
  serviceFee      Decimal       @db.Decimal(10, 2)
  totalPrice      Decimal       @db.Decimal(10, 2)
  
  status          BookingStatus @default(PENDENTE)
  message         String?       @db.Text
  
  activities      Activity[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([propertyId])
  @@index([guestId])
  @@index([ownerId])
  @@index([status])
  @@index([checkIn, checkOut])
}

model Favorite {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id])
  
  createdAt   DateTime @default(now())
  
  @@unique([userId, propertyId])
  @@index([userId])
}

model Activity {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  
  type        ActivityType
  title       String
  description String?
  
  propertyId  String?
  property    Property?    @relation(fields: [propertyId], references: [id])
  
  bookingId   String?
  booking     Booking?     @relation(fields: [bookingId], references: [id])
  
  createdAt   DateTime     @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

model ChatConversation {
  id                  String        @id @default(cuid())
  
  propertyId          String
  property            Property      @relation(fields: [propertyId], references: [id])
  
  clientId            String
  client              User          @relation("ClientConversations", fields: [clientId], references: [id])
  
  ownerId             String
  owner               User          @relation("OwnerConversations", fields: [ownerId], references: [id])
  
  lastMessage         String?
  lastMessageTime     DateTime?
  
  messages            ChatMessage[]
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  @@unique([propertyId, clientId])
  @@index([clientId])
  @@index([ownerId])
}

model ChatMessage {
  id              String            @id @default(cuid())
  
  conversationId  String
  conversation    ChatConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId        String
  senderRole      SenderRole
  
  text            String            @db.Text
  status          MessageStatus     @default(SENT)
  
  createdAt       DateTime          @default(now())
  
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}
